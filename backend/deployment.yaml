chartVersion: 0.2.7

project:
  name: "booking"

repository:
  name: "markmorcos/booking"
  path: "backend"

ingress:
  host: booking.morcos.tech
  rules:
    - host: booking.morcos.tech
      path: /(.*)
      pathType: ImplementationSpecific
      serviceName: booking-service

deployments:
  - name: booking-deployment
    image: markmorcos/booking
    env:
      - name: RAILS_ENV
        value: production
      - name: PGHOST
        valueFrom:
          secretKeyRef:
            name: postgres-secrets
            key: PGHOST
      - name: PGUSER
        valueFrom:
          secretKeyRef:
            name: postgres-secrets
            key: PGUSER
      - name: PGPASSWORD
        valueFrom:
          secretKeyRef:
            name: postgres-secrets
            key: PGPASSWORD
      - name: PGDATABASE
        valueFrom:
          secretKeyRef:
            name: postgres-secrets
            key: PGDATABASE
      - name: PGPORT
        valueFrom:
          secretKeyRef:
            name: postgres-secrets
            key: PGPORT
      - name: SECRET_KEY_BASE
        valueFrom:
          secretKeyRef:
            name: rails-secret
            key: SECRET_KEY_BASE
      - name: SMTP_ADDRESS
        valueFrom:
          secretKeyRef:
            name: smtp-secrets
            key: SMTP_ADDRESS
      - name: SMTP_DOMAIN
        valueFrom:
          secretKeyRef:
            name: smtp-secrets
            key: SMTP_DOMAIN
      - name: SMTP_PORT
        valueFrom:
          secretKeyRef:
            name: smtp-secrets
            key: SMTP_PORT
      - name: SMTP_USERNAME
        valueFrom:
          secretKeyRef:
            name: smtp-secrets
            key: SMTP_USERNAME
      - name: SMTP_PASSWORD
        valueFrom:
          secretKeyRef:
            name: smtp-secrets
            key: SMTP_PASSWORD

services:
  - name: booking-service
    port: 80

jobs:
  - name: prepare-database-job
    image: markmorcos/booking
    command: ["bundle", "exec", "rails", "db:create", "db:migrate", "db:seed"]
